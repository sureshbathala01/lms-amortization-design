# S1.1: New Loan Creation - Complete End-to-End Flow

**Version**: 1.0  
**Date**: November 4, 2025  
**Status**: ✅ Complete  
**Milestone**: M1 - Foundation

---

## Overview

This document describes the complete end-to-end flow for creating a new loan in the LMS through an API call from the Loan Origination System (LOS).

### Scenario Summary
- **Trigger**: API call from LOS
- **Input**: Customer ID, Product, Version, Loan details, Parameter overrides
- **Output**: Loan created in CREATED status with Loan ID (Packet ID)
- **Duration**: Synchronous (< 5 seconds)
- **Transaction**: Atomic (loan + parameters committed together)

---

## Table of Contents
1. [Preconditions](#preconditions)
2. [API Request Structure](#api-request-structure)
3. [Processing Flow](#processing-flow)
4. [Data Model](#data-model)
5. [Post-Creation Activities](#post-creation-activities)
6. [Error Scenarios](#error-scenarios)
7. [Audit Trail](#audit-trail)

---

## Preconditions

### System State Requirements
1. ✅ **Product exists** in system (e.g., "HOME_LOAN", "PERSONAL_LOAN")
2. ✅ **Product version active** (e.g., v1.2 is deployed and active)
3. ✅ **Customer account exists** in LMS
4. ✅ **Parameters defined** (global and product-level parameters configured)
5. ✅ **Java class deployed** for the product version

### Business Prerequisites
1. ✅ Customer application approved in LOS
2. ✅ Credit checks completed
3. ✅ Loan terms agreed upon
4. ✅ Ready for disbursement processing

---

## API Request Structure

### Endpoint
```
POST /api/loans/create
Content-Type: application/json
Authorization: Bearer {token}
```

### Request Payload

```json
{
  "customerId": "CUST123456",
  "productCode": "HOME_LOAN",
  "productVersion": "1.2",
  
  "loanDetails": {
    "principalAmount": 5000000,
    "tenure": 240,
    "tenureUnit": "MONTHS",
    "disbursementDate": "2025-11-15",
    "purpose": "Home Purchase",
    "loanOfficerId": "LO789",
    "branchCode": "BR001"
  },
  
  "parameterOverrides": {
    "interestRate": 8.5,
    "processingFee": 10000,
    "prepaymentPenaltyRate": 2.0
  },
  
  "additionalInfo": {
    "collateralReference": "PROP456",
    "insuranceRequired": true
  }
}
```

### Request Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| customerId | String | Yes | Existing customer identifier |
| productCode | String | Yes | Product type (HOME_LOAN, PERSONAL_LOAN, etc.) |
| productVersion | String | Yes | Specific version (e.g., "1.2") |
| loanDetails.principalAmount | Number | Yes | Loan amount in INR |
| loanDetails.tenure | Integer | Yes | Loan duration |
| loanDetails.tenureUnit | String | Yes | MONTHS or YEARS |
| loanDetails.disbursementDate | Date | Yes | Planned disbursement date (can be future) |
| parameterOverrides | Object | No | Loan-specific parameter values |

---

## Processing Flow

### Phase 1: Request Reception & Class Loading

```
API Request Received
    ↓
1. LMS Captures Timestamp
   - creation_date = NOW()
   - Source: LMS system time
   
2. Extract Request Data
   - productCode = "HOME_LOAN"
   - productVersion = "1.2"
   - customerId, loanDetails, parameterOverrides
   
3. Load Product Version Java Class
   - Lookup: product_versions table
   - Find: product_code='HOME_LOAN' AND version_number='1.2' AND active=true
   - Get: java_class_path = "com.lms.products.HomeLoan_v1_2"
   - Load: HomeLoan_v1_2.class into JVM
   - ✅ Class contains all validation and calculation logic
```

**Key Point**: Java class loaded IMMEDIATELY at API reception.

---

### Phase 2: Validation

All validation logic resides within the product version Java class.

#### 2.1: Customer Validation
```java
// Within HomeLoan_v1_2.class
public ValidationResult validateCustomer(String customerId) {
    Customer customer = customerRepository.findById(customerId);
    
    if (customer == null) {
        return ValidationResult.fail("Customer not found: " + customerId);
    }
    
    if (!customer.isActive()) {
        return ValidationResult.fail("Customer account is inactive");
    }
    
    return ValidationResult.success();
}
```

❌ **If fails**: Reject API with error response

#### 2.2: Product Version Validation
```java
public ValidationResult validateProductVersion() {
    ProductVersion version = productVersionRepository
        .findByCodeAndVersion(productCode, productVersion);
    
    if (version == null) {
        return ValidationResult.fail("Product version not found");
    }
    
    if (!version.isActive()) {
        return ValidationResult.fail("Product version is not active");
    }
    
    // Store for later use
    this.productVersionReleaseDate = version.getReleaseDate();
    
    return ValidationResult.success();
}
```

❌ **If fails**: Reject API with error response

**Note**: `impactfulChange` flag is NOT checked here - it only affects migration of existing loans, not new loan creation.

#### 2.3: Parameter Override Validation
```java
public ValidationResult validateParameterOverrides(
    Map<String, Object> overrides) {
    
    List<String> errors = new ArrayList<>();
    Map<String, Object> validOverrides = new HashMap<>();
    
    for (Entry<String, Object> override : overrides.entrySet()) {
        String paramName = override.getKey();
        Object paramValue = override.getValue();
        
        // 1. Check if parameter exists in metadata
        ParameterMetadata metadata = 
            parameterMetadataRepository.findByName(paramName);
        
        if (metadata == null) {
            // Unknown parameter - ignore (don't reject)
            logger.warn("Unknown parameter in override: " + paramName);
            continue;
        }
        
        // 2. Check if overridable via API
        if (!metadata.isOverridableInAPI()) {
            // Not overridable - ignore (don't reject)
            logger.warn("Parameter not overridable: " + paramName);
            continue;
        }
        
        // 3. Validate value type
        if (!metadata.isValidType(paramValue)) {
            errors.add("Invalid type for " + paramName);
            continue;
        }
        
        // 4. Validate value range
        if (!metadata.isValidRange(paramValue)) {
            errors.add("Invalid value for " + paramName + 
                      ": must be between " + metadata.getMinValue() + 
                      " and " + metadata.getMaxValue());
            continue;
        }
        
        // Valid override
        validOverrides.put(paramName, paramValue);
    }
    
    if (!errors.isEmpty()) {
        return ValidationResult.fail(String.join(", ", errors));
    }
    
    // Store valid overrides for later
    this.validatedOverrides = validOverrides;
    
    return ValidationResult.success();
}
```

**Behavior**:
- ✅ Valid overrides → Accepted
- ⚠️ Unknown parameter → Ignored (logged, not rejected)
- ⚠️ Non-overridable parameter → Ignored (logged, not rejected)
- ❌ Invalid value/range → Rejected

#### 2.4: Business Rules Validation
```java
public ValidationResult validateBusinessRules(LoanRequest request) {
    List<String> errors = new ArrayList<>();
    
    // Principal amount validation
    if (request.getPrincipalAmount() <= 0) {
        errors.add("Principal amount must be greater than zero");
    }
    
    if (request.getPrincipalAmount() > getMaxLoanAmount()) {
        errors.add("Principal exceeds maximum allowed: " + 
                  getMaxLoanAmount());
    }
    
    // Tenure validation
    if (request.getTenure() <= 0) {
        errors.add("Tenure must be greater than zero");
    }
    
    if (request.getTenure() > getMaxTenure()) {
        errors.add("Tenure exceeds maximum allowed: " + 
                  getMaxTenure());
    }
    
    // Date validation
    LocalDate creationDate = LocalDate.now();
    LocalDate disbursementDate = request.getDisbursementDate();
    
    if (disbursementDate.isBefore(creationDate)) {
        errors.add("Disbursement date cannot be in the past");
    }
    
    // Product-specific rules (defined in this version)
    ValidationResult customRules = validateCustomRules(request);
    if (!customRules.isValid()) {
        errors.addAll(customRules.getErrors());
    }
    
    if (!errors.isEmpty()) {
        return ValidationResult.fail(String.join(", ", errors));
    }
    
    return ValidationResult.success();
}
```

❌ **If fails**: Reject API with error response

---

### Phase 3: Loan Record Creation (Database Transaction)

If ALL validations pass, proceed to database transaction.

```java
@Transactional
public CreateLoanResponse createLoan(LoanRequest request) {
    
    // 1. Generate unique Loan ID (Packet ID)
    String loanId = loanIdGenerator.generate();
    // Example: "LN2025110400001"
    
    // 2. Retrieve product version release date
    // (Already loaded during validation)
    LocalDate productVersionEffectiveDate = this.productVersionReleaseDate;
    
    // 3. Create Loan Record
    Loan loan = new Loan();
    loan.setLoanId(loanId);  // This is also the Packet ID
    loan.setCustomerId(request.getCustomerId());
    loan.setProductCode(request.getProductCode());
    loan.setProductVersion(request.getProductVersion());
    loan.setProductVersionEffectiveDate(productVersionEffectiveDate);
    loan.setPrincipalAmount(request.getPrincipalAmount());
    loan.setTenure(request.getTenure());
    loan.setTenureUnit(request.getTenureUnit());
    loan.setDisbursementDate(request.getDisbursementDate());
    loan.setCreationDate(LocalDateTime.now());
    loan.setStatus(LoanStatus.CREATED);
    loan.setCreatedBy(request.getLoanOfficerId());
    loan.setCreatedBySystem("LOS");
    
    loanRepository.save(loan);
    
    // 4. Store Parameter Overrides
    for (Entry<String, Object> override : this.validatedOverrides.entrySet()) {
        LoanParameter loanParam = new LoanParameter();
        loanParam.setLoanId(loanId);
        loanParam.setParameterName(override.getKey());
        loanParam.setParameterValue(override.getValue().toString());
        loanParam.setParameterType("LOAN_OVERRIDE");
        loanParam.setEffectiveFrom(loan.getCreationDate().toLocalDate());
        loanParam.setEffectiveTo(null);  // Open-ended
        loanParam.setTransactionTime(LocalDateTime.now());
        loanParam.setValidFrom(loan.getCreationDate().toLocalDate());
        loanParam.setCreatedBy(request.getLoanOfficerId());
        
        loanParameterRepository.save(loanParam);
    }
    
    // 5. Commit Transaction
    // Spring @Transactional handles commit/rollback
    
    // 6. Return Response
    return new CreateLoanResponse(loanId, LoanStatus.CREATED, 
                                  loan.getCreationDate());
}
```

**SQL Equivalent**:
```sql
BEGIN TRANSACTION;

-- Insert loan record
INSERT INTO loans (
    loan_id,
    customer_id,
    product_code,
    product_version,
    product_version_effective_date,
    principal_amount,
    tenure,
    tenure_unit,
    disbursement_date,
    creation_date,
    status,
    created_by,
    created_by_system
) VALUES (
    'LN2025110400001',
    'CUST123456',
    'HOME_LOAN',
    '1.2',
    '2025-01-01',          -- Product v1.2 release date
    5000000,
    240,
    'MONTHS',
    '2025-11-15',
    '2025-11-04 10:30:45', -- NOW()
    'CREATED',
    'LO789',
    'LOS'
);

-- Insert parameter overrides
INSERT INTO loan_parameters (
    loan_id,
    parameter_name,
    parameter_value,
    parameter_type,
    effective_from,
    effective_to,
    transaction_time,
    valid_from,
    created_by
) VALUES 
(
    'LN2025110400001',
    'interestRate',
    '8.5',
    'LOAN_OVERRIDE',
    '2025-11-04',
    NULL,
    '2025-11-04 10:30:45',
    '2025-11-04',
    'LO789'
),
(
    'LN2025110400001',
    'processingFee',
    '10000',
    'LOAN_OVERRIDE',
    '2025-11-04',
    NULL,
    '2025-11-04 10:30:45',
    '2025-11-04',
    'LO789'
);

COMMIT;
```

**Result**: 
- ✅ Loan record created in CREATED status
- ✅ Parameter overrides stored
- ✅ No amortization schedule yet (generated later)

---

### Phase 4: API Response

```json
{
  "status": "SUCCESS",
  "packetId": "LN2025110400001",
  "loanStatus": "CREATED",
  "creationDate": "2025-11-04T10:30:45Z",
  "message": "Loan created successfully"
}
```

**Response Fields**:
| Field | Description |
|-------|-------------|
| status | SUCCESS or ERROR |
| packetId | Unique loan identifier (also loan_id) |
| loanStatus | Current status (CREATED) |
| creationDate | Timestamp when loan was created |

LOS receives this response and can track the loan using packetId.

---

## Data Model

### Entities Involved

#### 1. loans
```sql
CREATE TABLE loans (
    loan_id VARCHAR(50) PRIMARY KEY,        -- Also packet_id
    customer_id VARCHAR(50) NOT NULL,
    product_code VARCHAR(50) NOT NULL,
    product_version VARCHAR(20) NOT NULL,
    product_version_effective_date DATE NOT NULL,  -- Version release date
    principal_amount DECIMAL(15,2) NOT NULL,
    tenure INT NOT NULL,
    tenure_unit VARCHAR(10) NOT NULL,       -- MONTHS or YEARS
    disbursement_date DATE,                 -- Planned disbursement
    creation_date TIMESTAMP NOT NULL,       -- When loan created
    activated_date TIMESTAMP,               -- When became ACTIVE
    status VARCHAR(20) NOT NULL,            -- CREATED, AUTHORIZED, etc.
    created_by VARCHAR(50),
    created_by_system VARCHAR(50),
    
    FOREIGN KEY (customer_id) REFERENCES customers(customer_id),
    FOREIGN KEY (product_code) REFERENCES products(product_code),
    FOREIGN KEY (product_code, product_version) 
        REFERENCES product_versions(product_code, version_number)
);

CREATE INDEX idx_loans_status ON loans(status);
CREATE INDEX idx_loans_customer ON loans(customer_id);
CREATE INDEX idx_loans_product ON loans(product_code, product_version);
```

#### 2. loan_parameters (Bi-temporal)
```sql
CREATE TABLE loan_parameters (
    loan_parameter_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    loan_id VARCHAR(50) NOT NULL,
    parameter_name VARCHAR(100) NOT NULL,
    parameter_value VARCHAR(500) NOT NULL,
    parameter_type VARCHAR(50) NOT NULL,    -- LOAN_OVERRIDE
    effective_from DATE NOT NULL,           -- Valid-time start
    effective_to DATE,                      -- Valid-time end (nullable)
    transaction_time TIMESTAMP NOT NULL,    -- When recorded
    valid_from DATE NOT NULL,               -- Bi-temporal valid-time
    created_by VARCHAR(50),
    
    FOREIGN KEY (loan_id) REFERENCES loans(loan_id),
    FOREIGN KEY (parameter_name) REFERENCES parameter_metadata(parameter_name)
);

CREATE INDEX idx_loan_params_loan ON loan_parameters(loan_id);
CREATE INDEX idx_loan_params_bitemporal 
    ON loan_parameters(loan_id, parameter_name, effective_from, transaction_time);
```

#### 3. products
```sql
CREATE TABLE products (
    product_code VARCHAR(50) PRIMARY KEY,
    product_name VARCHAR(200) NOT NULL,
    description TEXT,
    active BOOLEAN NOT NULL DEFAULT true,
    created_date TIMESTAMP NOT NULL,
    created_by VARCHAR(50)
);
```

#### 4. product_versions
```sql
CREATE TABLE product_versions (
    product_version_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    product_code VARCHAR(50) NOT NULL,
    version_number VARCHAR(20) NOT NULL,
    java_class_path VARCHAR(500) NOT NULL,
    release_date DATE NOT NULL,             -- When version deployed
    impactful_change BOOLEAN NOT NULL,
    active BOOLEAN NOT NULL DEFAULT true,
    migration_validator_class VARCHAR(500),
    description TEXT,
    created_date TIMESTAMP NOT NULL,
    created_by VARCHAR(50),
    
    FOREIGN KEY (product_code) REFERENCES products(product_code),
    UNIQUE KEY uk_product_version (product_code, version_number)
);

CREATE INDEX idx_pv_active ON product_versions(product_code, active);
```

#### 5. parameter_metadata
```sql
CREATE TABLE parameter_metadata (
    parameter_name VARCHAR(100) PRIMARY KEY,
    parameter_type VARCHAR(50) NOT NULL,    -- STRING, NUMBER, DATE, BOOLEAN
    overridable_in_api BOOLEAN NOT NULL,
    requires_migration BOOLEAN NOT NULL,
    validation_rules JSON,
    description TEXT,
    created_date TIMESTAMP NOT NULL
);
```

---

## Post-Creation Activities

After loan is created in CREATED status, several activities can occur:

### 1. Simulation Schedule Generation (Optional)

**Purpose**: Preview/what-if analysis before disbursement

**API Call**:
```
GET /api/loans/{loanId}/simulate-schedule
```

**Process**:
1. Load loan record (status can be CREATED or AUTHORIZED)
2. Load product version Java class
3. Resolve parameters (bi-temporal query as-of simulation date)
   - Check loan_parameters (overrides)
   - Else product_parameters
   - Else global_parameters
4. Call calculateAmortization() method
5. Return schedule JSON (NOT stored in database)

**Response**:
```json
{
  "loanId": "LN2025110400001",
  "simulationType": "VIEW_ONLY",
  "effectiveDate": "2025-11-04",
  "schedule": {
    "installments": [
      {
        "installmentNumber": 1,
        "dueDate": "2025-12-15",
        "principalDue": 15000,
        "interestDue": 35000,
        "feesDue": 0,
        "totalDue": 50000,
        "outstandingBalance": 4985000
      },
      // ... more installments
    ],
    "summary": {
      "totalInstallments": 240,
      "totalPrincipal": 5000000,
      "totalInterest": 2500000,
      "totalAmount": 7500000
    }
  }
}
```

**Key Characteristics**:
- ✅ Can be called unlimited times
- ✅ Always uses current effective parameter values (bi-temporal)
- ✅ Results cached for 5 minutes (TTL) for performance
- ✅ Shows immediate impact of parameter changes
- ⚠️ **NOT stored in database** - view-only
- ⚠️ Actual schedule generated at disbursement

---

### 2. Operations Authorization (Manual)

**Process**:
1. Operations team logs into LMS
2. Views loans in CREATED status
3. Reviews:
   - Customer documents (from document management system)
   - Loan parameters
   - API request details
   - [Optional] Simulation schedule
4. Makes decision:
   - ✅ **AUTHORIZE**: Status → AUTHORIZED
   - ❌ **REJECT**: Status → REJECTED, notify LOS

**Operations Access**:
- ✅ View all information (read-only)
- ✅ Authorize loan
- ✅ Reject loan with reason
- ❌ Cannot modify any loan data
- ❌ Cannot change parameters

**Status Transition**:
```sql
UPDATE loans 
SET status = 'AUTHORIZED',
    authorized_date = NOW(),
    authorized_by = 'OPS123'
WHERE loan_id = 'LN2025110400001'
  AND status = 'CREATED';
```

---

### 3. Disbursement & Actual Schedule Generation

**When**: Disbursement transaction is posted

**API Call**:
```
POST /api/loans/{loanId}/disburse
{
  "transactionDate": "2025-11-15",
  "realizationDate": "2025-11-15",
  "amount": 5000000,
  "paymentMode": "NEFT",
  "referenceNumber": "NEFT123456"
}
```

**Process**:
```
BEGIN TRANSACTION

1. Validate Loan Status (must be AUTHORIZED)

2. Post Disbursement Transaction
   INSERT INTO transactions (...)

3. Update Loan Status to ACTIVE
   UPDATE loans SET status='ACTIVE', 
                   disbursement_date='2025-11-15',
                   activated_date=NOW()

4. Generate Actual Amortization Schedule
   a. Load product version Java class
   b. Resolve parameters (as-of realization_date)
   c. Call calculateAmortization()
      - Start date = realization_date (disbursement)
   d. Store schedule JSON
      INSERT INTO amortization_schedule (...)

COMMIT TRANSACTION
```

**Schedule Storage**:
```sql
INSERT INTO amortization_schedule (
    schedule_id,
    loan_id,
    schedule_version,           -- 1 (first version)
    effective_from,             -- Realization date
    effective_to,               -- NULL (current schedule)
    schedule_data,              -- JSON blob
    generated_date,
    product_version_used,
    generated_by_event
) VALUES (
    uuid(),
    'LN2025110400001',
    1,
    '2025-11-15',
    NULL,
    '{"installments":[...],"summary":{...}}',
    NOW(),
    '1.2',
    'DISBURSEMENT'
);
```

**Result**:
- ✅ Loan status = ACTIVE
- ✅ Official amortization schedule stored
- ✅ Interest calculation starts from disbursement date
- ✅ Loan ready for payment postings

---

## Error Scenarios

### 1. Customer Not Found
**Error Response**:
```json
{
  "status": "ERROR",
  "errorCode": "CUSTOMER_NOT_FOUND",
  "message": "Customer not found: CUST123456",
  "timestamp": "2025-11-04T10:30:45Z"
}
```
**HTTP Status**: 404 Not Found

---

### 2. Product Version Inactive
**Error Response**:
```json
{
  "status": "ERROR",
  "errorCode": "PRODUCT_VERSION_INACTIVE",
  "message": "Product version HOME_LOAN v1.2 is not active",
  "timestamp": "2025-11-04T10:30:45Z"
}
```
**HTTP Status**: 400 Bad Request

---

### 3. Invalid Parameter Override
**Error Response**:
```json
{
  "status": "ERROR",
  "errorCode": "INVALID_PARAMETER_VALUE",
  "message": "Invalid value for interestRate: must be between 7.0 and 12.0",
  "timestamp": "2025-11-04T10:30:45Z"
}
```
**HTTP Status**: 400 Bad Request

---

### 4. Business Rule Violation
**Error Response**:
```json
{
  "status": "ERROR",
  "errorCode": "BUSINESS_RULE_VIOLATION",
  "message": "Principal exceeds maximum allowed: 10000000",
  "timestamp": "2025-11-04T10:30:45Z"
}
```
**HTTP Status**: 400 Bad Request

---

### 5. Database Transaction Failure
**Error Response**:
```json
{
  "status": "ERROR",
  "errorCode": "INTERNAL_SERVER_ERROR",
  "message": "Failed to create loan. Please retry.",
  "timestamp": "2025-11-04T10:30:45Z"
}
```
**HTTP Status**: 500 Internal Server Error

**Behavior**: 
- Transaction rolled back
- No loan record created
- No parameter records created
- Idempotent: LOS can safely retry

---

## Audit Trail

Every loan creation is fully auditable:

### Audit Information Captured

1. **Loan Record**:
   - Who created: `created_by` (loan officer ID)
   - When created: `creation_date` (timestamp)
   - From which system: `created_by_system` (LOS)
   - Which product version: `product_version` + `product_version_effective_date`

2. **Parameter Overrides**:
   - What was overridden: `parameter_name` + `parameter_value`
   - When effective: `effective_from` (valid-time)
   - When recorded: `transaction_time`
   - Who set it: `created_by`

3. **Product Version**:
   - Which version used: Stored in loan record
   - When that version was released: `product_version_effective_date`
   - Which Java class: Stored in product_versions table

### Audit Query Example

```sql
-- Complete audit trail for a loan
SELECT 
    l.loan_id,
    l.customer_id,
    l.product_code,
    l.product_version,
    l.product_version_effective_date AS version_released,
    l.creation_date AS loan_created,
    l.created_by,
    l.created_by_system,
    pv.java_class_path,
    GROUP_CONCAT(
        CONCAT(lp.parameter_name, '=', lp.parameter_value)
        SEPARATOR ', '
    ) AS parameter_overrides
FROM loans l
JOIN product_versions pv 
    ON l.product_code = pv.product_code 
    AND l.product_version = pv.version_number
LEFT JOIN loan_parameters lp 
    ON l.loan_id = lp.loan_id 
    AND lp.parameter_type = 'LOAN_OVERRIDE'
WHERE l.loan_id = 'LN2025110400001'
GROUP BY l.loan_id;
```

**Result**:
```
loan_id:           LN2025110400001
customer_id:       CUST123456
product_code:      HOME_LOAN
product_version:   1.2
version_released:  2025-01-01
loan_created:      2025-11-04 10:30:45
created_by:        LO789
created_by_system: LOS
java_class_path:   com.lms.products.HomeLoan_v1_2
overrides:         interestRate=8.5, processingFee=10000
```

### Regulatory Compliance

This audit trail enables:
- ✅ **Reproducibility**: Can recreate exact loan state at creation
- ✅ **Traceability**: Know who, what, when, where, why
- ✅ **Version Tracking**: Know which logic was used
- ✅ **Parameter History**: Know what values were effective when
- ✅ **RBI Compliance**: Meet audit requirements

---

## Performance Considerations

### 1. Java Class Loading
- **Strategy**: Cache loaded classes in memory
- **Cache Key**: `product_code:version_number`
- **Eviction**: LRU with configurable size
- **Benefit**: Avoid repeated class loading for same version

### 2. Parameter Resolution Caching
- **Strategy**: Cache resolved parameters for 5 minutes
- **Cache Key**: `loan_id:parameters:as_of_date`
- **TTL**: 300 seconds
- **Benefit**: Faster simulation schedule generation

### 3. Database Indexing
- **Critical Indexes**:
  - `loans(status)` - Find CREATED/AUTHORIZED loans
  - `loans(customer_id)` - Customer loan lookup
  - `loans(product_code, product_version)` - Product queries
  - `loan_parameters(loan_id, parameter_name, effective_from)` - Bi-temporal queries

### 4. Transaction Optimization
- **Keep transactions short**: Only loan + parameters creation
- **Defer heavy operations**: Schedule generation done separately
- **Connection pooling**: Maintain adequate pool size

---

## Success Criteria

S1.1 is successful when:

1. ✅ Loan record created in CREATED status
2. ✅ Parameter overrides validated and stored
3. ✅ Product version correctly captured
4. ✅ Loan ID (Packet ID) returned to LOS
5. ✅ Complete audit trail captured
6. ✅ Transaction atomic (all-or-nothing)
7. ✅ Validation errors properly handled
8. ✅ Response time < 5 seconds for normal case

---

## Open Questions / Future Enhancements

1. **Bulk Loan Creation**: API to create multiple loans in one call?
2. **Async Processing**: Should creation be async for very large volumes?
3. **Webhook Notifications**: Notify LOS of status changes (authorized, rejected)?
4. **Draft Loans**: Support saving incomplete loan data as draft?
5. **Loan Modification**: API to modify CREATED loans before authorization?

---

## Related Documents

- [Scenario Catalog](../../02-scenarios/scenario-catalog.md) - S1.1 definition
- [Milestone 1 Overview](../../03-milestones/milestone-overview.md) - M1 scope
- [Data Model](../../05-data-model/) - Complete entity definitions
- [Problem Statement](../../01-problem-statement/problem-statement.md) - Context

---

## Change Log

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-11-04 | 1.0 | Design Team | Initial complete flow documentation |

---

**Document Owner**: [To be assigned]  
**Reviewers**: [To be assigned]  
**Next Review Date**: After M1 completion
